@startuml enhanced_process_purchases_flow

actor Cliente
participant "API Gateway" as Gateway
database "Tabela Anti-Duplicação" as AntiDup
queue "order_queue" as OrderQueue
participant "Processador" as Processor
database "Tabela Pedidos" as Orders
queue "process-purchases" as ProcessPurchases
queue "dlq" as DLQ

Cliente -> Gateway: POST /pedido {user_id, itens}
activate Gateway

Gateway -> AntiDup: Verifica pedidos recentes\n(user_id, últimos 1m)
AntiDup --> Gateway: Existe? 

alt Pedido similar existe
    Gateway --> Cliente: 409 Conflict
else 
    Gateway -> AntiDup: Insere no topic\n(id_pedido, user_id, status: "PENDING")
    Gateway -> OrderQueue: Envia mensagem\n(id_pedido)
    Gateway --> Cliente: 202 Accepted
end

deactivate Gateway

...

OrderQueue -> Processor: Consome mensagem
activate Processor

Processor -> AntiDup: Busca status\n(id_pedido)
AntiDup --> Processor: Status

alt Status já é "PROCESSED"
    Processor --> OrderQueue: **Commit imediato**
else
    Processor -> Orders: Registra pedido
    Processor -> AntiDup: Atualiza status: "PROCESSED"  **// Ponto de não-retorno**
    Processor -> ProcessPurchases: Envia para processar o pagamento
    Processor -> OrderQueue: Commit offset
end

alt Erro durante processamento
    Processor -> Processor: Log error + metrics
    alt Erro transitório
        Processor -> OrderQueue: Reenfileira com delay
    else Erro permanente
        Processor -> DLQ: Envia mensagem
        Processor -> OrderQueue: Commit offset
    end
end

deactivate Processor
@enduml